local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- Compatibility for different executors (Synapse, Fluxus, etc.)
local queueteleport = (syn and syn.queue_on_teleport) or queue_on_teleport or (fluxus and fluxus.queue_on_teleport)
local TeleportCheck = false

-- Wait until Workspace.Filter exists before running
local function waitForFilter()
    while not game:GetService("Workspace"):FindFirstChild("Filter") do
        RunService.Heartbeat:Wait() -- check every frame
    end
end

-- Wait for Filter before continuing
waitForFilter()

-- If EntityModels exist in Workspace, load the in-game script
-- Otherwise, load the pre-game (selection) script
if game:GetService("Workspace"):FindFirstChild("EntityModels") then
    loadstring(game:HttpGet('https://raw.githubusercontent.com/Jonmaster2007/NIC/refs/heads/main/InGame'))()
else
    loadstring(game:HttpGet('https://raw.githubusercontent.com/Jonmaster2007/NIC/refs/heads/main/PreGame'))()
end

-- Handle teleporting: re-execute script after teleport
Players.LocalPlayer.OnTeleport:Connect(function(State)
    if not TeleportCheck and queueteleport then
        TeleportCheck = true
        queueteleport([[
            local RunService = game:GetService("RunService")
            local loaded = false
            local connection

            -- Wait for the game to fully load
            connection = RunService.Heartbeat:Connect(function()
                if game:IsLoaded() then
                    loaded = true
                    connection:Disconnect() -- stop checking
                end
            end)

            -- Fallback: wait up to 5 seconds
            repeat wait(1) until loaded or time() > 5

            -- Wait until Workspace.Filter exists
            local function waitForFilter()
                while not game:GetService("Workspace"):FindFirstChild("Filter") do
                    RunService.Heartbeat:Wait()
                end
            end
            waitForFilter()

            -- Load the framework script after teleport
            loadstring(game:HttpGet('https://raw.githubusercontent.com/Jonmaster2007/NIC/refs/heads/main/Teleport'))()
        ]])
    end
end)
